(function(j){function o(a){return a}function r(a){var b=j.map(a.attributes,function(a){return a.name});j(a).removeClass();j.each(b,function(b,d){a.removeAttribute(d)})}function l(a){return s==ice.dom.getTagName(a)}function x(a){a=ice.dom.getTagName(a);return s===a||y===a}function u(a,b,c){var d=a.length;if(0>b||b>=d)return a;b+c>=d&&(c=d-b);if(c===d)return a;a=0<b?a.splitText(b):a;a.length>c&&a.splitText(c);return a}function v(a,b,c,d){d?(c=c.createTextNode("﻿"),a?a.appendChild(c):b.insertNode(c),
b.selectNode(c)):a&&b.selectNodeContents(a)}var w,q,s="br",y="p";w={attributes:{changeId:"data-cid",userId:"data-userid",userName:"data-username",sessionId:"data-session-id",time:"data-time",lastTime:"data-last-change-time",changeData:"data-changedata"},attrValuePrefix:"",blockEl:"p",blockEls:"div p ol ul li h1 h2 h3 h4 h5 h6 blockquote".split(" "),stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"span",alias:"ins",action:"Inserted"},deleteType:{tag:"span",alias:"del",
action:"Deleted"}},contentEditable:void 0,_isTracking:!0,tooltips:!1,tooltipsDelay:1,_isVisible:!0,_changeData:null,_handleSelectAll:!1,_sessionId:null};q=function(a){a||(a={});if(!a.element)throw Error("options.element must be defined for ice construction.");this._changes={};this._userStyles={};this._styles={};this._savedNodesMap={};this.$this=j(this);this._browser=ice.dom.browser();this._tooltipMouseOver=this._tooltipMouseOver.bind(this);this._tooltipMouseOut=this._tooltipMouseOut.bind(this);this._boundEventHandler=
this.handleEvent.bind(this);ice.dom.extend(!0,this,w,a);if(a.tooltips&&(!j.isFunction(a.hostMethods.showTooltip)||!j.isFunction(a.hostMethods.hideTooltip)))throw Error("hostMethods.showTooltip and hostMethods.hideTooltip must be defined if tooltips is true");var b=a.userStyles||{},c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c];isNaN(d)||(this._userStyles[c]=this.stylePrefix+"-"+d,this._uniqueStyleIndex=Math.max(d,this._uniqueStyleIndex),this._styles[d]=!0)}k=a.hostMethods.logError||function(){}};
q.prototype={_uniqueStyleIndex:0,_browserType:null,_batchChangeId:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(){"boolean"==typeof this.contentEditable&&this.element.setAttribute("contentEditable",this.contentEditable);this.initializeEnvironment();this.initializeEditor();this.initializeRange();this._updateTooltipsState();return this},stopTracking:function(a){this._isTracking=!1;try{var b=this.element;b&&(b.removeEventListener("keyup",this._boundEventHandler,
!0),b.removeEventListener("keydown",this._boundEventHandler,!0),b.removeEventListener("keypress",this._boundEventHandler,!0));!a&&"undefined"!=typeof this.contentEditable&&this.element.setAttribute("contentEditable",!this.contentEditable)}catch(c){k(c,"While trying to stop tracking")}this._updateTooltipsState();return this},listenToEvents:function(){this.unlistenToEvents();this.element&&this.element.addEventListener("keydown",this._boundEventHandler,!0)},unlistenToEvents:function(){this.element&&
this.element.removeEventListener("keydown",this._boundEventHandler,!0)},initializeEnvironment:function(){this.env||(this.env={});this.env.element=this.element;this.env.document=this.element.ownerDocument;this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window;this.env.frame=this.env.window.frameElement;this.env.selection=this.selection=new ice.Selection(this.env)},initializeRange:function(){},initializeEditor:function(){this._loadFromDom();this._updateTooltipsState()},
isTracking:function(){return this._isTracking},enableChangeTracking:function(){this._isTracking=!0},disableChangeTracking:function(){this._isTracking=!1},toggleChangeTracking:function(a){this._isTracking=a=void 0===a?!this._isTracking:!!a},setCurrentUser:function(a){this.currentUser=a;this._updateUserData(a)},setSessionId:function(a){this._sessionId=a},toggleTooltips:function(a){this.tooltips=a=void 0===a?!this.tooltips:Boolean(a);this._updateTooltipsState()},visible:function(a){a.nodeType===ice.dom.TEXT_NODE&&
(a=a.parentNode);a=a.getBoundingClientRect();return 0<a.top&&0<a.left},_createIceNode:function(a,b,c){var d=this.env.document.createElement(this.changeTypes[a].tag);d.setAttribute("class",this._getIceNodeClass(a));b&&d.appendChild(b);this._addChange(a,[d],c);return d},insert:function(a){this.hostMethods.beforeInsert&&this.hostMethods.beforeInsert();var b=this._isRangeInElement(this.getCurrentRange(),this.element),c=b?null:this.hostMethods.getHostRange(),d=this._startBatchChange(),f=!(!b||b.collapsed),
e=!1,a=a||{};try{if(f&&(this._deleteContents(!1,b),b=this.getCurrentRange()),b||c){var g=a.nodes;g&&!j.isArray(g)&&(g=[g]);this._moveRangeToValidTrackingPos(b,c);e=this._insertNodes(b,c,{nodes:g,text:a.text,insertStubText:!1!==a.insertStubText})}}catch(i){k(i,"while trying to insert nodes")}finally{this._endBatchChange(d)}return e},_deleteContents:function(a,b){var c=!0,d=this._browser;this.hostMethods.beforeDelete&&this.hostMethods.beforeDelete();b?this.selection.addRange(b):b=this.getCurrentRange();
var f=this._startBatchChange();try{if(!1===b.collapsed){if((b=this._deleteSelection(b))&&!this.visible(b.endContainer))b.setEnd(b.endContainer,Math.max(0,b.endOffset-1)),b.collapse(!1)}else if(this._cleanupSelection(b,!1,!0),a)if("mozilla"===d.type)c=this._deleteRight(b),this.visible(b.endContainer)||(b.endContainer.parentNode.nextSibling?b.setEndBefore(b.endContainer.parentNode.nextSibling):b.setEndAfter(b.endContainer),b.collapse(!1));else{if(b.endOffset===ice.dom.getNodeCharacterLength(b.endContainer)){var e=
b.startContainer.nextSibling;if(ice.dom.is(e,"."+this._getIceNodeClass("deleteType")))for(;e;)if(ice.dom.is(e,"."+this._getIceNodeClass("deleteType")))e=e.nextSibling;else{b.setStart(e,0);b.collapse(!0);break}}c=this._deleteRight(b);!this.visible(b.endContainer)&&ice.dom.is(b.endContainer.parentNode,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&(b.setStartAfter(b.endContainer.parentNode),b.collapse(!0))}else if(d.mozilla)c=this._deleteLeft(b),this.visible(b.startContainer)||
(b.startContainer.parentNode.previousSibling?b.setEnd(b.startContainer.parentNode.previousSibling,0):b.setEnd(b.startContainer.parentNode,0),b.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(b.endContainer)),b.collapse(!1));else{if(!this.visible(b.startContainer)&&b.endOffset===ice.dom.getNodeCharacterLength(b.endContainer)){var g=b.startContainer.previousSibling;if(ice.dom.is(g,"."+this._getIceNodeClass("deleteType")))for(;g;)if(ice.dom.is(g,"."+this._getIceNodeClass("deleteType")))g=
g.prevSibling;else{b.setEndBefore(g.nextSibling,0);b.collapse(!1);break}}c=this._deleteLeft(b)}b&&this.selection.addRange(b)}finally{this._endBatchChange(f)}return c},getChanges:function(){return this._changes},getChangeUserids:function(){var a=this,b=Object.keys(this._changes);return b.map(function(c){return a._changes[b[c]].userid}).sort().filter(function(a,b,f){return b===f.indexOf(a)?1:0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(a,b,c){return(a=this.getCleanDOM(a,
{callback:b,prepare:c,clone:!0}))&&a.innerHTML||""},getCleanDOM:function(a,b){var c="",d=this,b=b||{};ice.dom.each(this.changeTypes,function(a,b){"deleteType"!=a&&(0<b&&(c+=","),c+="."+d._getIceNodeClass(a))});a?"string"===typeof a?a=ice.dom.create("<div>"+a+"</div>"):b.clone&&(a=ice.dom.cloneNode(a,!1)[0]):a=b.clone?ice.dom.cloneNode(this.element,!1)[0]:this.element;return this._cleanBody(a,c,b)},_cleanBody:function(a,b,c){a=c.prepare?c.prepare.call(this,a):a;b=ice.dom.find(a,b);ice.dom.each(b,function(a,
b){for(;b.firstChild;)b.parentNode.insertBefore(b.firstChild,b);b.parentNode.removeChild(b)});b=ice.dom.find(a,"."+this._getIceNodeClass("deleteType"));ice.dom.remove(b);return a=c.callback?c.callback.call(this,a):a},acceptAll:function(a){if(a)return this._acceptRejectSome(a,!0);this.getCleanDOM(this.element,{clone:!1});this._changes={};this._triggerChange()},rejectAll:function(a){if(a)return this._acceptRejectSome(a,!1);var a="."+this._getIceNodeClass("insertType"),b="."+this._getIceNodeClass("deleteType"),
c,d=this;ice.dom.find(this.element,a).each(function(a,b){d._removeNode(b)});ice.dom.each(ice.dom.find(this.element,b),function(a,b){c=ice.dom.contents(b);ice.dom.replaceWith(b,c);j.each(c,function(a,b){d._normalizeNode(b&&b.parentNode)})});this._changes={};this._triggerChange()},acceptChange:function(a){this.acceptRejectChange(a,!0)},rejectChange:function(a){this.acceptRejectChange(a,!1)},acceptRejectChange:function(a,b){var c,d,f,e,g=ice.dom,i=this,h,m,p=this._userStyles,t,k=this.attributes.userId,
n=this._getIceNodeClass("deleteType"),l=this._getIceNodeClass("insertType");if(!a){e=this.getCurrentRange();if(!e||!e.collapsed)return;a=e.startContainer}c=f="."+n;d=e="."+l;b||(f=d,e=c);c=g.getNode(a,c+","+d);c=g.attr(c,this.attributes.changeId);f=g.find(this.element,f+"["+this.attributes.changeId+"="+c+"]");d=f.length;f.each(function(a,b){i._removeNode(b)});f=g.find(this.element,e+"["+this.attributes.changeId+"="+c+"]");d+=f.length;g.each(f,function(a,b){if(x(b))return r(b);t=b.getAttribute(k);
m=t!==null?p[t]||"":"";h=ice.dom.contents(b);j(b).removeClass(l+" "+n+" "+m);g.replaceWith(b,h);j.each(h,function(a,b){var c=ice.dom.TEXT_NODE==b.nodeType&&b.nodeValue;if(c){for(var d=false;c.indexOf("  ")>=0;){d=true;c=c.replace("  ","  ")}if(d)b.nodeValue=c}i._normalizeNode(b&&b.parentNode)})});delete this._changes[c];0<d&&this._triggerChange()},isInsideChange:function(a,b,c){try{return!!this.currentChangeNode(a,b,c)}catch(d){return k(d,"While testing if isInsideChange"),!1}},getIceNodes:function(){var a=
[],b=this;ice.dom.each(this.changeTypes,function(c){a.push("."+b._getIceNodeClass(c))});a=a.join(",");return j(this.element).find(a)},_getIceNode:function(a,b){var c=this.changeTypes[b].tag+"."+this._getIceNodeClass(b);return ice.dom.getNode(a&&a.$||a,c)},_isNodeOfChangeType:function(a,b){if(!a)return!1;var c="."+this._getIceNodeClass(b);return ice.dom.is(a.$||a,c)},_isInsertNode:function(a){return this._isNodeOfChangeType(a,"insertType")},_isDeleteNode:function(a){return this._isNodeOfChangeType(a,
"deleteType")},_normalizeNode:function(a){return ice.dom.normalizeNode(a,this._browser.msie)},_moveRangeToValidTrackingPos:function(a,b){if(a=b||a)for(var c,d,f=-1,e,g=[],i=b?this.hostMethods.getHostNode:o,h=!1;!h;){d=a.startContainer;if(!d||0<=g.indexOf(d))break;e=i(d);g.push(d);if(c=this._getVoidElement(e)){if(c!=d&&0<=g.indexOf(c))break;g.push(c)}else h=ice.dom.isTextContainer(e);if(!h){if(-1==f){f=i(a.startContainer);d=a.startOffset;if(f)var m=f.nodeType,f=ice.dom.TEXT_NODE==m?d&&f.nodeValue&&
d>=f.nodeValue.length-1:ice.dom.ELEMENT_NODE==m?f.childNodes&&f.childNodes.length&&d>=f.childNodes.length:!1;else f=!1;f=!f}c=f?ice.dom.findPrevTextContainer(c||e,this.element):ice.dom.findNextTextContainer(c||e,this.element);e=c.node;b&&(e=this.hostMethods.makeHostElement(e));try{f?a.setStart(e,c.offset):a.setEnd(e,c.offset),a.collapse(f)}catch(p){k(p,"While trying to move range to valid tracking position");break}}}},_isRangeInElement:function(a,b){for(var c=a&&a.startContainer;c;){if(c==b)return a;
c=c.parentNode}return null},_getVoidElement:function(a){try{var b=this._getIceNode(a,"deleteType");return!b&&3==a.nodeType&&"​"==a.nodeValue?a:b}catch(c){return k(c,"While trying to get void element of",a),null}},_cleanupSelection:function(a,b,c){var d;if(a&&a.collapsed&&(d=a.startContainer))return b&&(d=this.hostMethods.getHostNode(d)),ice.dom.TEXT_NODE==d.nodeType?this._cleanupTextSelection(a,d,b,c):this._cleanupElementSelection(a,b)},_cleanupTextSelection:function(a,b,c,d){this._cleanupAroundNode(b);
if(d&&ice.dom.isEmptyTextNode(b)){var d=b.parentNode,f=ice.dom.getNodeIndex(b),c=c?this.hostMethods.makeHostElement:o;d.removeChild(b);f=Math.max(0,f);a.setStart(c(d),f);a.setEnd(c(d),f)}},_cleanupElementSelection:function(a,b){var c,d=!1,f=b?this.hostMethods.getHostNode(a.startContainer):a.startContainer,e=f.childNodes.length;if(!(1>e)){try{if(0<a.startOffset?c=f.childNodes[a.startOffset-1]:(c=f.firstChild,d=!0),!c)return}catch(g){return}this._cleanupAroundNode(c,d);if(0!==a.startOffset&&(d=ice.dom.getNodeIndex(c)+
1,ice.dom.isEmptyTextNode(c)&&(d=Math.max(0,d-1),f.removeChild(c)),f.childNodes.length!=e))c=b?this.hostMethods.makeHostElement:o,a.setStart(c(f),d),a.setEnd(c(f),d)}},_cleanupAroundNode:function(a,b){for(var c=a.parentNode,d=a.nextSibling,f;d;)ice.dom.isEmptyTextNode(d)?(f=d,d=d.nextSibling,c.removeChild(f)):d=d.nextSibling;for(d=a.previousSibling;d;)ice.dom.isEmptyTextNode(d)?(f=d,d=d.previousSibling,c.removeChild(f)):d=d.previousSibling;b&&ice.dom.isEmptyTextNode(a)&&c.removeChild(a)},_isCurrentUserIceNode:function(a){var b=
a&&ice.dom.attr(a,this.attributes.userId)==this.currentUser.id;b&&this._sessionId&&(b=ice.dom.attr(a,this.attributes.sessionId)===this._sessionId);return b},_getChangeTypeFromAlias:function(a){var b,c=null;for(b in this.changeTypes)this.changeTypes.hasOwnProperty(b)&&this.changeTypes[b].alias==a&&(c=b);return c},_getIceNodeClass:function(a){return this.attrValuePrefix+this.changeTypes[a].alias},_getUserStyle:function(a){if(null===a||""===a||"undefined"==typeof a)return this.stylePrefix;var b=null;
return b=this._userStyles[a]?this._userStyles[a]:this._setUserStyle(a,this._getNewStyleId())},_setUserStyle:function(a,b){var c=this.stylePrefix+"-"+b;this._styles[b]||(this._styles[b]=!0);return this._userStyles[a]=c},_getNewStyleId:function(){var a=++this._uniqueStyleIndex;if(this._styles[a])return this._getNewStyleId();this._styles[a]=!0;return a},_addChange:function(a,b,c){var d=c||this._batchChangeId||this.getNewChangeId(),f=this;this._changes[d]||(c=(new Date).getTime(),this._changes[d]={type:a,
time:c,lastTime:c,sessionId:this._sessionId,userid:""+this.currentUser.id,username:this.currentUser.name,data:this._changeData||""},this._triggerChange());ice.dom.foreach(b,function(a){f._addNodeToChange(d,b[a])});return d},_addNodeToChange:function(a,b){var c=this.getChange(a),d={};b.getAttribute(this.attributes.changeId)||(d[this.attributes.changeId]=a);var f=b.getAttribute(this.attributes.userId);f||(f=c.userid,d[this.attributes.userId]=f);f==c.userid&&(d[this.attributes.userName]=c.username);
null===b.getAttribute(this.attributes.changeData)&&(d[this.attributes.changeData]=this._changeData||"");b.getAttribute(this.attributes.time)||(d[this.attributes.time]=c.time);b.getAttribute(this.attributes.lastTime)||(d[this.attributes.lastTime]=c.lastTime);c.sessionId&&!b.getAttribute(this.attributes.sessionId)&&(d[this.attributes.sessionId]=c.sessionId);c.style||(c.style=this._getUserStyle(c.userid));j(b).attr(d).addClass(c.style);this._updateNodeTooltip(b)},getChange:function(a){return this._changes[a]||
null},getNewChangeId:function(){var a=++this._uniqueIDIndex;this._changes[a]&&(a=this.getNewChangeId());return a},_startBatchChange:function(){return this._batchChangeId?null:this._batchChangeId=this.getNewChangeId()},getContentElement:function(){return this.element},_endBatchChange:function(a){a&&a===this._batchChangeId&&(this._batchChangeId=null,this._triggerChangeText())},getCurrentRange:function(){try{return this.selection.getRangeAt(0)}catch(a){return k(a,"While trying to get current range"),
null}},_insertNodes:function(a,b,c){var a=b||a,c=c||{},d=a.startContainer,f=b?this.hostMethods.makeHostElement:o,e=c.nodes,g=!1!==c.insertStubText,i=c.text,h,m=this.env.document,c=!1;h=this._getIceNode(d&&d.$||d,"insertType");d=this._isCurrentUserIceNode(h);this._cleanupSelection(a,Boolean(b),!0);if(d){d=e&&e[0];i=h.getAttribute(this.attributes.changeId);if(d){c=!0;a.insertNode(f(d));f=d.parentNode;m=d.nextSibling;h=e.length;for(g=1;g<h;++g)m?f.insertBefore(e[g],m):f.appendChild(e[g]);e=e[h-1];ice.dom.TEXT_NODE==
e.nodeType?a.setEnd(e,e.nodeValue&&e.nodeValue.length||0):a.setEndAfter(e);a.collapse();b?this.hostMethods.setHostRange(b):this.selection.addRange(a)}else v(null,a,m,g);this._updateChangeTime(i)}else{d=this._createIceNode("insertType");if(h){var p=h.childNodes.length;this._normalizeNode(h);p!=h.childNodes.length&&(b?b=a=this.hostMethods.getHostRange():a.refresh());if(h&&(p=b&&this.hostMethods.getHostNode(b.endContainer)||a.endContainer,3==p.nodeType&&a.endOffset<a.endContainer.length||p!=h.lastChild))h=
this._splitNode(h,a.endContainer,a.endOffset)}h&&(a.setStartAfter(f(h)),a.collapse(!0));a.insertNode(f(d));if(h=e&&e.length||0){c=!0;for(g=0;g<h;++g)d.appendChild(e[g]);a.setEndAfter(f(d.lastChild));a.collapse()}else i?(c=!0,e=m.createTextNode(i),d.appendChild(e),a.setEnd(e,1),a.collapse()):v(d,a,m,g);b?this.hostMethods.setHostRange(b):this.selection.addRange(a)}return c},_updateChangeTime:function(a){var b=this._changes[a];if(b){var c=(new Date).getTime(),a=ice.dom.find(this.element,"["+this.attributes.changeId+
"="+a+"]"),d=this.attributes.lastTime;b.lastTime=c;a.each(function(a,b){b.setAttribute(d,c)})}},_handleVoidEl:function(a,b){var c=a&&this._getVoidElement(a);return c&&!this._getIceNode(c,"deleteType")?(b.collapse(!0),!0):!1},_deleteSelection:function(a){for(var b=new ice.Bookmark(this.env,a),c=ice.dom.getElementsBetween(b.start,b.end),d=[],f=0;f<c.length;f++){var e=c[f];if(e&&e.parentNode){if(ice.dom.isBlockElement(e)&&(d.push(e),!ice.dom.canContainTextElement(e))){for(var g=0;g<e.childNodes.length;g++)c.push(e.childNodes[g]);
continue}if(ice.dom.isEmptyTextNode(e))this._removeNode(e);else if(!this._getVoidElement(e))if(e.nodeType!==ice.dom.TEXT_NODE)if(l(e))this._addDeleteTrackingToBreak(e);else if(ice.dom.isStubElement(e))this._addDeleteTracking(e,{range:null,moveLeft:!0});else if(ice.dom.hasNoTextOrStubContent(e))this._removeNode(e);else for(g=0;g<e.childNodes.length;g++)c.push(e.childNodes[g]);else g=ice.dom.getBlockParent(e),this._addDeleteTracking(e,{range:null,moveLeft:!0}),ice.dom.hasNoTextOrStubContent(g)&&ice.dom.remove(g)}}b.selectBookmark();
(a=this.getCurrentRange())&&a.collapse(!0);return a},_deleteRight:function(a){var b=ice.dom.isBlockElement(a.startContainer)&&a.startContainer||ice.dom.getBlockParent(a.startContainer,this.element)||null,c=b?ice.dom.hasNoTextOrStubContent(b):!1,d=b&&ice.dom.getNextContentNode(b,this.element),f=d?ice.dom.hasNoTextOrStubContent(d):!1,e=a.endContainer,g=a.endOffset,i=a.commonAncestorContainer,h,m=!1;if(c)return!1;if(l(i))return this._addDeleteTrackingToBreak(i,{range:a}),!0;if(i.nodeType!==ice.dom.TEXT_NODE){if(0===
g&&(ice.dom.isBlockElement(i)&&!ice.dom.canContainTextElement(i))&&(b=i.firstElementChild))return a.setStart(b,0),a.collapse(),this._deleteRight(a);if(i.childNodes.length>g){b=i.childNodes[g];if(l(b))return this._addDeleteTrackingToBreak(b,{range:a}),!0;a.setStart(i.childNodes[g],0);a.collapse(!0);m=this._deleteRight(a);a.refresh();return m}if(h=ice.dom.getNextContentNode(i,this.element)){if(l(h))return this._addDeleteTrackingToBreak(h,{range:a}),!0;a.setEnd(h,0)}a.collapse();return this._deleteRight(a)}try{a.moveEnd(ice.dom.CHARACTER_UNIT,
1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(p){}if(g===e.data.length&&!ice.dom.hasNoTextOrStubContent(e)){h=ice.dom.getNextNode(e,this.element);if(!h)return a.selectNodeContents(e),a.collapse(),!1;if(l(h))return this._addDeleteTrackingToBreak(h,{range:a}),!0;h.nodeType===ice.dom.TEXT_NODE&&(h=h.parentNode);if(!h.isContentEditable)return m=this._addDeleteTracking(h,{range:null,moveLeft:!1,merge:!0}),b=this.env.document.createTextNode(""),h.parentNode.insertBefore(b,h.nextSibling),a.selectNode(b),
a.collapse(!0),m;if(this._handleVoidEl(h,a))return!0;if(ice.dom.isChildOf(h,b)&&ice.dom.isStubElement(h))return this._addDeleteTracking(h,{range:a,moveLeft:!1,merge:!0})}if(this._handleVoidEl(h,a))return!0;if(ice.dom.isOnBlockBoundary(a.startContainer,a.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(h,this.element),this.blockEl)){d!==ice.dom.getBlockParent(a.endContainer,this.element)&&a.setEnd(d,0);i=ice.dom.getElementsBetween(a.startContainer,a.endContainer);
for(g=0;g<i.length;g++)ice.dom.remove(i[g]);return ice.dom.mergeBlockWithSibling(a,ice.dom.getBlockParent(a.endContainer,this.element)||b)}if(f)return ice.dom.remove(d),a.collapse(!0),!0;a.setStart(d,0);a.collapse(!0);return!0}return this._addDeleteTracking(u(a.endContainer,a.endOffset,1),{range:a,moveLeft:!1,merge:!0})},_deleteLeft:function(a){var b=ice.dom.isBlockElement(a.startContainer)&&a.startContainer||ice.dom.getBlockParent(a.startContainer,this.element)||null,c=b?ice.dom.hasNoTextOrStubContent(b):
!1,d=b&&ice.dom.getPrevContentNode(b,this.element),f=d?ice.dom.hasNoTextOrStubContent(d):!1,e=a.startContainer,g=a.startOffset,i=a.commonAncestorContainer;if(c)return!1;if(l(i))return this._addDeleteTrackingToBreak(i,{range:a,moveLeft:!0}),!0;if(0===g||i.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(i)&&!ice.dom.canContainTextElement(i))if(0===g){if(c=i.firstElementChild)return a.setStart(c,0),a.collapse(),this._deleteLeft(a)}else if(c=i.lastElementChild)if(c=a.getLastSelectableChild(c))return a.setStart(c,
c.data.length),a.collapse(),this._deleteLeft(a);e=0===g?ice.dom.getPrevContentNode(e,this.element):i.childNodes[g-1];if(!e)return!1;ice.dom.is(e,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&(0<e.childNodes.length&&e.lastChild)&&(e=e.lastChild);if(l(e))return this._addDeleteTrackingToBreak(e,{range:a,moveLeft:!0}),!0;e.nodeType===ice.dom.TEXT_NODE&&(e=e.parentNode);if(!e.isContentEditable)return b=this._addDeleteTracking(e,{range:null,moveLeft:!0,merge:!0}),d=
document.createTextNode(""),e.parentNode.insertBefore(d,e),a.selectNode(d),a.collapse(!0),b;if(this._handleVoidEl(e,a))return!0;if(ice.dom.isStubElement(e)&&ice.dom.isChildOf(e,b)||!e.isContentEditable)return this._addDeleteTracking(e,{range:a,moveLeft:!0,merge:!0}),!0;if(ice.dom.isStubElement(e))return ice.dom.remove(e),a.collapse(!0),!1;if(e!==b&&!ice.dom.isChildOf(e,b)){ice.dom.canContainTextElement(e)||(e=e.lastElementChild);if(e.lastChild&&e.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(e.lastChild)&&
"BR"!==e.lastChild.tagName)return a.setStartAfter(e.lastChild),a.collapse(!0),!0;if((c=a.getLastSelectableChild(e))&&!ice.dom.isOnBlockBoundary(a.startContainer,c,this.element))return a.selectNodeContents(c),a.collapse(),!0}}if(1===g&&!ice.dom.isBlockElement(i)&&1<a.startContainer.childNodes.length&&a.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&0===a.startContainer.childNodes[0].data.length)return a.setStart(a.startContainer,0),this._deleteLeft(a);try{a.moveStart(ice.dom.CHARACTER_UNIT,
-1),a.moveStart(ice.dom.CHARACTER_UNIT,1)}catch(h){}if(ice.dom.isOnBlockBoundary(a.startContainer,a.endContainer,this.element)){if(f)return ice.dom.remove(d),a.collapse(),!0;if(d&&d.lastChild&&ice.dom.isStubElement(d.lastChild))return a.setStartAfter(d.lastChild),a.collapse(!0),!0;(c=a.getLastSelectableChild(d))?(a.setStart(c,c.data.length),a.collapse(!0)):d&&(a.setStart(d,d.childNodes.length),a.collapse(!0));return!0}return(b=a.startContainer)&&b.nodeType===ice.dom.TEXT_NODE?(this._addDeleteTracking(u(b,
a.startOffset-1,1),{range:a,moveLeft:!0,merge:!0}),!0):!1},_removeNode:function(a){var b=a&&a.parentNode;b&&(b.removeChild(a),b!=this.element&&ice.dom.hasNoTextOrStubContent(b)&&this._removeNode(b))},_addDeleteTracking:function(a,b){var c=b&&b.moveLeft,d=this._getIceNode(a,"insertType"),f;if(d)return this._addDeletionInInsertNode(a,d,b);if((d=b&&b.range)&&this._getIceNode(a,"deleteType"))return this._deleteInDeleted(a,b);a.previousSibling&&ice.dom.isEmptyTextNode(a.previousSibling)&&a.parentNode.removeChild(a.previousSibling);
a.nextSibling&&ice.dom.isEmptyTextNode(a.nextSibling)&&a.parentNode.removeChild(a.nextSibling);f=this._getIceNode(a.previousSibling,"deleteType");var e=this._getIceNode(a.nextSibling,"deleteType");if(f&&this._isCurrentUserIceNode(f)){if(f.appendChild(a),e&&this._isCurrentUserIceNode(e)){var g=ice.dom.extractContent(e);ice.dom.append(f,g);e.parentNode.removeChild(e)}}else e&&this._isCurrentUserIceNode(e)?(f=e,f.insertBefore(a,f.firstChild)):(f=this._createIceNode("deleteType",null,this.getAdjacentChangeId(a,
c)),a.parentNode.insertBefore(f,a),f.appendChild(a));d&&(ice.dom.isStubElement(a)?d.selectNode(a):d.selectNodeContents(a),c?d.collapse(!0):d.collapse());f&&(this._normalizeNode(f),d&&d.refresh());return!0},_addDeleteTrackingToBreak:function(a,b){function c(){var c=b&&b.range;c&&(l(a)||ice.dom.hasNoTextOrStubContent(a)||d?d?(c.setStartBefore(a),c.setEndBefore(a)):(c.setStartAfter(a),c.setEndAfter(a)):a.firstChild&&(c.setStartBefore(a.firstChild),c.setEndBefore(a.firstChild)),c.collapse())}var d=Boolean(b&&
b.moveLeft);if(l(a)){if(this._isDeleteNode(a))return c();r(a);ice.dom.addClass(a,this._getIceNodeClass("deleteType"));var f=this.getAdjacentChangeId(a,d);this._addChange("deleteType",[a],f);c()}else k("addDeleteTracking to BR: not a break element")},_deleteInDeleted:function(a,b){var c=b.range,d=b.moveLeft;this._normalizeNode(a);var f=!1;if(d){for(var e=ice.dom.getPrevContentNode(a,this.element);!f;)(d=this._getIceNode(e,"deleteType"))?e=ice.dom.getPrevContentNode(e,this.element):f=!0;e&&((f=c.getLastSelectableChild(e))&&
(e=f),c.setStart(e,ice.dom.getNodeCharacterLength(e)),c.collapse(!0))}else{for(e=ice.dom.getNextContentNode(a,this.element);!f;)(d=this._getIceNode(e,"deleteType"))?e=ice.dom.getNextContentNode(e,this.element):f=!0;e&&(c.selectNodeContents(e),c.collapse(!0))}return!0},_addDeletionInInsertNode:function(a,b,c){var d=c&&c.range,f=c&&c.moveLeft;if(this._isCurrentUserIceNode(b)){if(d&&(f?d.setStartBefore(a):d.setStartAfter(a),d.collapse(f)),a.parentNode.removeChild(a),this._browser.msie||this._normalizeNode(b),
0<ice.dom.find(b,".iceBookmark").length?(a=ice.dom.cloneNode(b),ice.dom.remove(ice.dom.find(a,".iceBookmark")),a=a[0]):a=b,ice.dom.hasNoTextOrStubContent(a))d&&(d.setStartBefore(b),d.collapse(!0)),ice.dom.replaceWith(b,ice.dom.contents(b))}else{var e=rangy.dom.getNodeIndex(a),g=a.parentNode,i=g.childNodes.length,h;g.removeChild(a);h=this._createIceNode("deleteType");h.appendChild(a);0<e&&e>=i-1?ice.dom.insertAfter(b,h):(0<e&&this._splitNode(b,g,e),b.parentNode.insertBefore(h,b));this._deleteEmptyNode(b);
d&&f&&(d.setStartBefore(h),d.collapse(!0),this.selection.addRange(d));c&&c.merge&&this._mergeDeleteNode(h);d&&d.refresh()}return!0},_deleteEmptyNode:function(a){var b=a&&a.parentNode;b&&ice.dom.hasNoTextOrStubContent(a)&&b.removeChild(a)},_mergeDeleteNode:function(a){var b,c;if(this._isCurrentUserIceNode(b=this._getIceNode(a.previousSibling,"deleteType")))c=ice.dom.extractContent(a),a.parentNode.removeChild(a),ice.dom.append(b,c),this._mergeDeleteNode(b);else if(this._isCurrentUserIceNode(b=this._getIceNode(a.nextSibling,
"deleteType")))c=ice.dom.extractContent(b),a.parentNode.removeChild(b),ice.dom.append(a,c),this._mergeDeleteNode(a)},handleEvent:function(a){if(!this._isTracking)return!0;var b=!1;"keypress"==a.type?b=this.keyPress(a):"keydown"==a.type&&(b=!this.handleKeyDown(a));b&&(a.stopImmediatePropagation(),a.preventDefault(),this.hostMethods.notifyChange());return!b},_handleAncillaryKey:function(a){var b=this._browser,c=!1,d=this.getCurrentRange();switch(a){case ice.dom.DOM_VK_DELETE:c=this._deleteContents();
break;case 46:c=this._deleteContents(!0);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:"mozilla"===b.type&&!this.visible(d.startContainer)&&(d.startContainer.parentNode.previousSibling?(d.setEnd(d.startContainer.parentNode.previousSibling,0),d.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(d.endContainer))):d.setEnd(d.startContainer.parentNode.nextSibling,0),d.collapse(!1));c=!1;break;case ice.dom.DOM_VK_RIGHT:"mozilla"===b.type&&(!this.visible(d.startContainer)&&
d.startContainer.parentNode.nextSibling)&&(d.setStart(d.startContainer.parentNode.nextSibling,0),d.collapse(!0))}return c},handleKeyDown:function(a){return this._handleSpecialKey(a)?!0:!this.keyPress(a)},onKeyDown:function(a){return this._handleSpecialKey(a)?!1:this._handleAncillaryKey(a)},keyPress:function(a){var b=null;if(a.ctrlKey||a.metaKey)return!1;var c=(b=this.getCurrentRange())&&ice.dom.parents(b.startContainer,"br")[0]||null;c&&b.moveToNextEl(c);a=a.keyCode?a.keyCode:a.which;switch(a){case 32:return this.insert({text:" "});
case ice.dom.DOM_VK_DELETE:case 46:case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:case ice.dom.DOM_VK_RIGHT:return this._handleAncillaryKey(a);case ice.dom.DOM_VK_ENTER:return this._handleEnter(),!1;default:return b=String.fromCharCode(a),null!==b?this.insert():!1}},_handleEnter:function(){var a=this.getCurrentRange();a&&!a.collapsed&&this._deleteContents()},_handleSpecialKey:function(a){var b=a.which;null===b&&(b=a.keyCode);switch(b){case 120:case 88:if(!0===a.ctrlKey||
!0===a.metaKey)return this.prepareToCut(),!0;break;case 67:case 99:if(!0===a.ctrlKey||!0===a.metaKey)return this.prepareToCopy(),!0}return!1},currentChangeNode:function(a,b,c){var d="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"),f=null;if(!a){f=this.getCurrentRange();if(!f)return!1;!1!==c&&f.collapsed?(this._cleanupSelection(f,!1,!1),a=f.startContainer):a=f.commonAncestorContainer}a=b?ice.dom.is(a,d)&&a:ice.dom.getNode(a,d);if(!a&&f&&f.collapsed){b=f.endContainer;
f=f.endOffset;c=null;if(b.nodeType===ice.dom.TEXT_NODE)f===b.length?c=ice.dom.getNextNode(b):0===f&&(c=ice.dom.getPrevNode(b,this.element));else if(b.nodeType===ice.dom.ELEMENT_NODE)if(0===f)c=ice.dom.getPrevNode(b,this.element);else if(b.childNodes.length>f){b=b.childNodes[f-1];if(ice.dom.is(b,d))return b;c=ice.dom.getNextNode(b)}c&&(a=ice.dom.is(c,d))}return a},setShowChanges:function(a){this._isVisible=a=!!a;j(this.element).toggleClass("ICE-Tracking",a);this._showTitles(a);this._updateTooltipsState()},
reload:function(){this._loadFromDom()},hasChanges:function(){for(var a in this._changes){var b=this._changes[a];if(b&&b.type)return!0}return!1},countChanges:function(a){return this._filterChanges(a).count},setChangeData:function(a){if(null==a||"undefined"==typeof a)a="";this._changeData=""+a},getDeleteClass:function(){return this._getIceNodeClass("deleteType")},prepareToCopy:function(){var a=this.getCurrentRange();a&&!a.collapsed&&this._removeTrackingInRange(a)},prepareToCut:function(){var a=this.getCurrentRange(),
b=this.hostMethods.getHostRange();if(a&&b&&a.collapsed&&!b.collapsed)try{var c=this.hostMethods.getHostRangeData(b);a.setStart(c.startContainer,c.startOffset);a.setEnd(c.endContainer,c.endOffset)}catch(d){return}if(!a||a.collapsed)return!1;b=this.element;if(a&&b&&!a.collapsed){var f;try{for(;(f=a.endContainer)&&(f!=b&&0==a.endOffset&&!a.collapsed)&&!(f.previousSibling?a.setEndBefore(f):f.parentNode&&f.parentNode!=b&&a.setEndBefore(f.parentNode),a.endContainer==f););}catch(e){k(e,"fixSelection, while trying to set end")}try{for(;(f=
a.startContainer)&&(f!=b&&!a.collapsed)&&!(f=a.startContainer,f.nodeType==ice.dom.TEXT_NODE?a.startOffset>=f.nodeValue.length&&a.setStartAfter(f):a.startOffset>=f.childNodes.length&&a.setStartAfter(f),a.startContainer==f););}catch(g){k(g,"fixSelection, while trying to set start")}}b=a.cloneContents();f=a.cloneRange();var c=b.firstChild,i=b.lastChild;this.hostMethods.beforeEdit();a.collapse(!1);a.insertNode(b);a.setStartBefore(c);a.setEndAfter(i);b=this._startBatchChange();try{this._deleteSelection(a)}catch(h){k(h,
"While trying to delete selection")}finally{this._endBatchChange(b),this.selection.addRange(f),this._removeTrackingInRange(f,!1)}return!0},toString:function(){return"ICE "+(this.element&&this.element.id||"(no element id)")},_splitNode:function(a,b,c){var d=a.parentNode,f=rangy.dom.getNodeIndex(a),e=b.ownerDocument.createRange();e.setStart(d,f);e.setEnd(b,c);b=e.extractContents();d.insertBefore(b,a);this.isInsideChange(a,!0)&&this._updateNodeTooltip(a.previousSibling);return a.previousSibling},_triggerChange:function(){this._isTracking&&
this.$this.trigger("change")},_triggerChangeText:function(){this.$this.trigger("textChange")},_updateNodeTooltip:function(a){this.tooltips&&this._isVisible&&this._addTooltip(a)},_acceptRejectSome:function(a,b){var c=function(a,c){this.acceptRejectChange(c,b)}.bind(this),d=this._filterChanges(a),f;for(f in d.changes)ice.dom.find(this.element,"["+this.attributes.changeId+"="+f+"]").each(c);d.count&&this._triggerChange()},_filterChanges:function(a){var b=0,c={},d;d=a||{};var a=d.filter,f=d.exclude?j.map(d.exclude,
function(a){return""+a}):null,e=d.include?j.map(d.include,function(a){return""+a}):null,g=d.verify,i=null,h;for(h in this._changes)if((d=this._changes[h])&&d.type)if(i=a&&!a({userid:d.userid,time:d.time,data:d.data})||f&&0<=f.indexOf(d.userid)||e&&0>e.indexOf(d.userid),!i&&(g&&(i=ice.dom.find(this.element,"["+this.attributes.changeId+"]"),i=!i.length),!i))++b,c[h]=d;return{count:b,changes:c}},_loadFromDom:function(){this._changes={};this._uniqueStyleIndex=0;var a=this.currentUser&&this.currentUser.id,
b=this.currentUser&&this.currentUser.name||"",c=(new Date).getTime(),d,f=RegExp(this.stylePrefix+"-(\\d+)"),e=[],g;for(g in this.changeTypes)e.push(this._getIceNodeClass(g));g=this.getIceNodes();var i=function(h,g){for(var i=0,j,k="",n=g.className.split(" "),h=0;h<n.length;h++){if(d=f.exec(n[h]))j=d[0],i=d[1];var l=RegExp("("+e.join("|")+")").exec(n[h]);l&&(k=this._getChangeTypeFromAlias(l[1]))}n=ice.dom.attr(g,this.attributes.userId);a&&n==a?(l=b,g.setAttribute(this.attributes.userName,b)):l=g.getAttribute(this.attributes.userName);
this._setUserStyle(n,Number(i));i=parseInt(ice.dom.attr(g,this.attributes.changeId)||"");isNaN(i)&&(i=this.getNewChangeId(),g.setAttribute(this.attributes.changeId,i));var o=parseInt(g.getAttribute(this.attributes.time)||"");isNaN(o)&&(o=c);var q=parseInt(g.getAttribute(this.attributes.lastTime)||"");isNaN(q)&&(q=o);var r=g.getAttribute(this.attributes.sessionId),s=ice.dom.attr(g,this.attributes.changeData)||"";this._changes[i]={type:k,style:j,userid:""+n,username:l,time:o,lastTime:q,sessionId:r,
data:s};this._updateNodeTooltip(g)}.bind(this);g.each(i);this._triggerChange()},_updateUserData:function(a){if(a)for(var b in this._changes){var c=this._changes[b];c.userid==a.id&&(c.username=a.name)}this.getIceNodes().each(function(b,c){var e=!a||a.id==c.getAttribute(this.attributes.userId);a&&e&&c.setAttribute(this.attributes.userName,a.name)}.bind(this))},_showTitles:function(a){var b=this.getIceNodes();a?j(b).each(function(a,b){this._updateNodeTooltip(b)}.bind(this)):j(b).removeAttr("title")},
_updateTooltipsState:function(){var a,b=this;this.tooltips&&this._isVisible?this._showingTips||(this._showingTips=!0,a=this.getIceNodes(),a.each(function(a,d){b._addTooltip(d)})):this._showingTips&&(this._showingTips=!1,a=this.getIceNodes(),a.each(function(a,b){j(b).unbind("mouseover").unbind("mouseout")}))},_addTooltip:function(a){j(a).unbind("mouseover").unbind("mouseout").mouseover(this._tooltipMouseOver).mouseout(this._tooltipMouseOut)},_tooltipMouseOver:function(a){var b=a.currentTarget,c=j(b),
d=this;c.data("_tooltip_t")||(a=setTimeout(function(){var a=d.currentChangeNode(b),e=a&&a.getAttribute(d.attributes.changeId),g=e&&d.getChange(e);g&&(a=ice.dom.hasClass(a,d._getIceNodeClass("insertType"))?"insert":"delete",c.removeData("_tooltip_t"),d.hostMethods.showTooltip(b,{userName:g.username,changeId:e,userId:g.userid,time:g.time,lastTime:g.lastTime,type:a}))},this.tooltipsDelay),c.data("_tooltip_t",a))},_tooltipMouseOut:function(a){var a=a.currentTarget,b=j(a),c=b.data("_tooltip_t");b.removeData("_tooltip_t");
c?clearTimeout(c):this.hostMethods.hideTooltip(a)},_removeTrackingInRangeOld:function(a){var b=this._getIceNodeClass("insertType"),c=this._getIceNodeClass("deleteType"),d="."+b+",."+c;a.getNodes(null,function(a){var b=null;a.nodeType==ice.dom.TEXT_NODE?b=j(a).parents(d):(a=j(a),b=a.is(d)?a:a.parents(d));return(a=b&&b[0])?(a.setAttribute("data-ice-class",a.className),a.setAttribute("class","ice-no-decoration"),!0):!1});var f=this.element;setTimeout(function(){j(f).find("[data-ice-class]").each(function(a,
b){var c=b.getAttribute("data-ice-class");c&&(b.setAttribute("class",c),b.removeAttribute("data-ice-class"))})},10)},_removeTrackingInRange:function(a){var b=this._getIceNodeClass("insertType"),c=this._getIceNodeClass("deleteType"),d="."+b+",."+c,f=this._savedNodesMap,e=Date.now()%1E6;a.getNodes(null,function(a){var b=null;a.nodeType==ice.dom.TEXT_NODE?b=j(a).parents(d):(a=j(a),b=a.is(d)?a:a.parents(d));if(a=b&&b[0]){for(var c=a.attributes,g,l=c&&c.length,b={},k=0;k<l;++k)g=c[k],b[g.name]=g.value;
g=a.className;c=""+e++;f[c]={attributes:b,className:g};a:{var b=null,n;try{for(;0<a.attributes.length;){n=a.attributes[0];if(n===b)break a;b=n;a.removeAttribute(n.name)}}catch(o){}}a.setAttribute("data-ice-class",c);a.setAttribute("class","ice-no-decoration");return!0}return!1});var g=this.element;setTimeout(function(){j(g).find("[data-ice-class]").each(function(a,b){var c=b.getAttribute("data-ice-class"),d=f[c];c?(delete f[c],Object.keys(d.attributes).forEach(function(a){b.setAttribute(a,d.attributes[a])}),
b.setAttribute("class",d.className),b.removeAttribute("data-ice-class")):k("missing save data for node")})},10)},getAdjacentChangeId:function(a,b){var c=b?ice.dom.getNextNode(a):ice.dom.getPrevNode(a),d,f=null;d=this._getIceNode(c,"insertType")||this._getIceNode(c,"deleteType");if(!d&&(this._isInsertNode(c)||this._isDeleteNode(c)))d=c;d&&this._isCurrentUserIceNode(d)&&(f=ice.dom.attr(d,this.attributes.changeId));return f}};var z=window&&window.console||{log:function(){},error:function(){},info:function(){},
assert:function(){},count:function(){}},k=null;this.ice=this.ice||{};this.ice.printRange=function(a,b){function c(a){if(!a)return"";a=a.replace("/\n/g","\\n").replace("/\r/g","").replace("​","{filler}").replace("﻿","{filler}");return 15>=a.length?a:a.substring(0,5)+"..."+a.substring(a.length-5)}function d(a){if(3===a.nodeType)a="Text:"+c(a.nodeValue);else var b=a.innerText,a=a.nodeName+(b?"("+c(b)+")":"");e.push("<"+a+" />")}function f(a,b,f){"number"!=typeof f&&(f=-1);if(3==a.nodeType)a=a.nodeValue,
e.push(c(a.substring(0,b))),e.push("|"),f>b?(e.push(c(a.substring(b,f))),e.push("|"),e.push(c(a.substring(f)))):e.push(c(a.substring(b)));else if(1==a.nodeType){var g=0,j=a.childNodes;d(a);for(g=0;g<b;++g)d(j[g]);e.push("|");if(f>b){for(g=b;g<f;++g)d(j[g]);e.push("|")}if(0<f&&f<j.length)for(b=j[f];b;)d(b),b=b.nextSibling}}if(a&&a.startContainer&&a.endContainer){var e=[];a.startContainer===a.endContainer?f(a.startContainer,a.startOffset,a.endOffset):(f(a.startContainer,a.startOffset),f(a.endContainer,
a.endOffset));var g=e.join(" ");b&&z.log(b+":"+g);return g}};this.ice.InlineChangeEditor=q}).call(this,window.jQuery);